<style>
    /* #mush--coming-soon-hero .section-wrapper{
        background-image: url({{ section.settings.image_mob |  img_url: 'master' }});
        background-repeat: no-repeat; 
        background-size: 100%;
        background-position: bottom;
    } */

    /* @media (min-width: 1280px){
        #mush--coming-soon-hero .section-wrapper{
            background-image: url({{ section.settings.image_desk |  img_url: 'master' }});
            background-size: cover;
        }
    } */

    .cf-turnstile {
      display: none; /* Hide by default */
      margin: 20px auto;
    }
    
    .cf-turnstile.visible {
      display: block; /* Show when visible class is added */
    }
    
</style>


<section id="mush--coming-soon-hero">
    <div class="section-wrapper flex flex-col items-center xl:flex-row gap-[42px] xl:gap-[75px] text-white relative px-6 lg:px-20 xl:px-[86px] bg-black pt-[126px] pb-11 lg:pt-[184px] xl:py-[184px] xl:pb-[100px] xl:min-h-screen">
        <div class="coming-soon--content xl:w-3/5 relative z-2">
            <div class="lg:px-16 xl:px-0 mx-auto relative z-[2] {% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in {% endif %}">
                <h1 class="uppercase text-[32px] xl:text-[64px] tracking-[-1.6px] xl:tracking-[-3.5px] font-bold text-center xl:text-left mb-3 xl:mb-11 leading-[1.1] text-transparent bg-clip-text bg-gradient-to-r from-[#F2008C] to-[#E45825]">
                    {{ section.settings.header }}
                </h1>
                <p class="text-sm xl:text-2xl tracking-[-0.7px] xl:tracking-[-1.2px] text-center xl:text-left xl:pr-20 mb-6 xl:mb-11">
                    {{ section.settings.subheader }}
                </p>
    
                <!-- Coming Soon: Newsletter -->
                <div class="newsletter-form--wrapper mb-12 xl:mb-11 relative z-[2] xl:pr-10">
                    <form id="klaviyo-signup-form--comingsoon" method="post" accept-charset="UTF-8" class="newsletter-form password--newsletter-form flex flex-col xl:flex-col items-center_ gap-4 justify-start w-full">
                        <input type="hidden" name="form_type" value="customer">
                        <input type="hidden" name="utf8" value="✓">

                        <!-- Honeypot Field (Bots fill this, humans won't) -->
                        <input type="text" name="extra_field" id="honeypot-field" style="display:none !important;" autocomplete="off">

    
                        <div class="flex flex-col xl:flex-row items-center gap-4 justify-center w-full">

                        
                          <input 
                          type="email" 
                          name="email" 
                          id="comingsoon-newsletter-email" 
                          placeholder="Email" 
                          class="bg-transparent w-full px-7 py-4 border border-white rounded-[62px] w-full text-sm xl:text-xl tracking-[-0.7px] xl:tracking-[-1.037px] font-light" 
                          required>
                          <button type="submit" class="coming-soon--submit-btn w-full min-h-[54px] btn bg-gradient-to-r from-[#F2008C] to-[#E74936] text-black uppercase cursor-pointer text-sm xl:text-xl font-semibold leading-[1.1] tracking-[-0.7px] xl:tracking-[-1.037px] max-w-[250px]">JOIN THE LIST</button>
                        </div>

                         <!-- Cloudflare Turnstile -->
                        <div id="cf-turnstile-container" class="cf-turnstile"></div>

    
                    </form>
                    <p id="response-message-cs" class="text-sm xl:text-base tracking-[-0.8px] xl:tracking-[-0.8px] absolute bottom-[-42px] xl:bottom-[-30px] "></p>

                </div>
            </div>
            


            <!-- Coming Soon USP -->
            <div class="flex items-center justify-center xl:justify-start flex-wrap gap-1 xl:gap-3 relative z-[2] {% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in {% endif %}">
                {% for block in section.blocks %}
                    <div class="inline-block flex items-center">
                        <span class="text-base xl:text-lg">✓</span>
                        <span class="text-[12px] xl:text-base tracking-[-0.6px] xl:tracking-[-0.8px] whitespace-nowrap leading-none">
                            {{ block.settings.usp }}
                        </span>
                    </div>
                {% endfor %}
            </div>


            
        </div>

        <div class="xl:w-2/5">
            <!-- Coming Soon Image Banner: Desktop-->
            <div class="hidden xl:block xl:px-2 relative z-0">
              <img src="{{ section.settings.image_desk |  img_url: 'master' }}" alt="Coming Soon">
            </div>


            <!-- Coming Soon Image Banner: Mobile-->
            <div class="xl:hidden relative z-0 px-10 max-w-[350px] mx-auto">
              <img src="{{ section.settings.image_mob |  img_url: 'master' }}" alt="Coming Soon">
            </div>
        </div>
    </div>
</section>




<script>
  // Define the callback function that Turnstile looks for when loaded
  window.onloadTurnstileCallback = function() {
    console.log("Turnstile API loaded via callback");
    window.turnstileLoaded = true;
  };
  
  document.addEventListener("DOMContentLoaded", function () {
    // Check if site key is configured
    const turnstileSiteKey = "{{ settings.cf_turnstile_site_key }}";
    if (!turnstileSiteKey || turnstileSiteKey.trim() === '') {
      console.error("ERROR: Cloudflare Turnstile site key is not configured in theme settings.");
      console.error("Please go to Theme Settings > Third-Party Integrations > Cloudflare Turnstile and enter your site key.");
    } else {
      console.log("Turnstile site key configured:", turnstileSiteKey);
    }
    
    const form = document.getElementById("klaviyo-signup-form--comingsoon");
    const emailInput = document.getElementById("comingsoon-newsletter-email");
    const honeypotField = document.getElementById("honeypot-field");
    const turnstileContainer = document.getElementById("cf-turnstile-container");
    const responseMessage = document.getElementById("response-message-cs");
    
    // Track if turnstile has been shown
    let turnstileShown = false;
    let turnstileWidgetId = null;
    let turnstileRetryCount = 0;
    const maxTurnstileRetries = 3;

    // Better script loading check
    function isTurnstileScriptLoaded() {
      return typeof window.turnstile !== 'undefined' && typeof window.turnstile.render === 'function';
    }
    
    // Function to load Turnstile script manually if needed
    function loadTurnstileScript(callback) {
      // If script is already loaded, just call the callback
      if (isTurnstileScriptLoaded()) {
        console.log("Turnstile already loaded, calling callback directly");
        if (callback) callback();
        return;
      }
      
      // If script is already in the DOM but not loaded yet, don't add another
      const existingScript = document.querySelector('script[src*="challenges.cloudflare.com/turnstile"]');
      if (existingScript) {
        console.log("Turnstile script tag already exists in DOM, waiting for it to load");
        existingScript.onload = callback;
        return;
      }
      
      // Create and add the script
      console.log("Creating new Turnstile script tag");
      const script = document.createElement('script');
      // Make sure onloadTurnstileCallback is defined before loading the script
      if (typeof window.onloadTurnstileCallback !== 'function') {
        window.onloadTurnstileCallback = function() {
          console.log("Turnstile API loaded via dynamically created callback");
          window.turnstileLoaded = true;
          if (callback) callback();
        };
      }
      script.src = "https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onloadTurnstileCallback";
      script.async = true;
      script.defer = true;
      script.onload = function() {
        console.log("Turnstile script loaded via dynamic insertion");
        // The callback will be called by onloadTurnstileCallback
      };
      script.onerror = function(e) {
        console.error("Error loading Turnstile script:", e);
      };
      document.head.appendChild(script);
      console.log("Manually loading Turnstile script - added to DOM");
    }
    
    // Function to check if turnstile is loaded
    function waitForTurnstile(callback, maxAttempts = 10, interval = 500) {
      let attempts = 0;
      
      const checkTurnstile = function() {
        attempts++;
        
        if (typeof window.turnstile !== 'undefined' && typeof window.turnstile.render === 'function') {
          console.log("Turnstile API found on attempt " + attempts);
          callback();
          return;
        }
        
        if (attempts < maxAttempts) {
          console.log("Waiting for Turnstile API, attempt " + attempts);
          setTimeout(checkTurnstile, interval);
        } else {
          console.error("Turnstile failed to load after maximum attempts");
          
          // Try to reload the script if we've tried less than maxTurnstileRetries times
          if (turnstileRetryCount < maxTurnstileRetries) {
            turnstileRetryCount++;
            console.log(`Retrying Turnstile script load (${turnstileRetryCount}/${maxTurnstileRetries})`);
            loadTurnstileScript(function() {
              waitForTurnstile(callback, maxAttempts, interval);
            });
          } else {
            responseMessage.innerText = "Verification service temporarily unavailable. Please try again later.";
            responseMessage.classList.add("text-orange");
          }
        }
      };
      
      checkTurnstile();
    }
    
    // Function to show turnstile
    function showTurnstile() {
      turnstileContainer.classList.add('visible');
      turnstileShown = true;
      responseMessage.innerText = "Please complete the verification below.";
      responseMessage.classList.add("text-orange");
      
      waitForTurnstile(function() {
        // Only render if not already rendered
        if (!turnstileWidgetId) {
          try {
            // Directly use a string for sitekey rather than a variable
            console.log("About to render Turnstile widget with fixed parameters");
            
            turnstileWidgetId = window.turnstile.render('#cf-turnstile-container', {
              sitekey: "0x4AAAAABeBT0ggatQl3Tpt", // Hardcoded key from your logs
              callback: function(token) {
                console.log("Turnstile callback received");
                // Auto-submit the form if token is received
                if (token) {
                  responseMessage.innerText = "Verification successful! Submitting...";
                  setTimeout(function() {
                    form.dispatchEvent(new Event('submit'));
                  }, 500);
                }
              }
            });
            console.log("Turnstile widget rendered successfully with ID:", turnstileWidgetId);
          } catch(e) {
            console.error("Error rendering Turnstile widget:", e);
            responseMessage.innerText = "Verification service error. Please refresh and try again.";
          }
        }
      });
      
      window.scrollTo({
        top: turnstileContainer.offsetTop - 100,
        behavior: 'smooth'
      });
    }
    
    // Function to reset turnstile
    function resetTurnstile() {
      if (typeof window.turnstile !== 'undefined' && turnstileWidgetId) {
        try {
          window.turnstile.reset(turnstileWidgetId);
        } catch(e) {
          console.error("Error resetting Turnstile:", e);
          turnstileWidgetId = null; // Reset the ID so we'll try to render it again next time
        }
      }
    }

    // Ensure Turnstile script is loaded when the page loads
    loadTurnstileScript();

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const email = emailInput.value;

      // 1️⃣ Basic Email Validation (Regex)
      const emailPattern = /^[a-zA-Z0-9.]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!emailPattern.test(email)) {
        responseMessage.innerText = "Invalid email address.";
        responseMessage.classList.add("text-orange");
        return;
      }
      console.log("✅ Basic email format validation passed");

      // 2️⃣ Honeypot Check (If filled, stop submission)
      if (honeypotField.value) {
        console.warn("Spam bot detected. Form submission aborted.");
        return;
      }
      console.log("✅ Honeypot check passed");

      // 3️⃣ Check If User is in the USA
      try {
        const geoResponse = await fetch("https://ipapi.co/json/");
        const geoData = await geoResponse.json();
        if (geoData.country !== "US" && geoData.country !== "IN") {
          responseMessage.innerText = "Sorry! Submissions outside of US are not allowed at the moment.";
          responseMessage.classList.add("text-orange");
          return;
        }
        console.log("✅ Geolocation check passed - User is from allowed country");
      } catch (error) {
        console.error("Geolocation API failed", error);
        responseMessage.innerText = "Unable to verify location. Please try again later.";
        responseMessage.classList.add("text-orange");
        return;
      }
      
      // 4️⃣ Show and verify Cloudflare Turnstile
      // If turnstile hasn't been shown yet, show it and stop here
      if (!turnstileShown) {
        showTurnstile();
        return;
      }
      
      // Check if turnstile was completed
      if (typeof window.turnstile === 'undefined') {
        // Try to load it once more
        loadTurnstileScript(function() {
          responseMessage.innerText = "Verification service loaded. Please try again.";
          showTurnstile();
        });
        return;
      }
      
      let turnstileToken;
      try {
        turnstileToken = window.turnstile.getResponse(turnstileWidgetId);
        if (!turnstileToken) {
          responseMessage.innerText = "Please complete the verification below.";
          responseMessage.classList.add("text-orange");
          return;
        }
        console.log("✅ Turnstile client-side check passed");
      } catch (e) {
        console.error("Error getting Turnstile response:", e);
        responseMessage.innerText = "Verification error. Please try again.";
        responseMessage.classList.add("text-orange");
        return;
      }

      // 5️⃣ ZeroBounce Email Validation and Turnstile Server-Side Validation
      responseMessage.innerText = "Validating email and verification...";
      responseMessage.classList.remove("text-orange", "text-successgreen");

      try {
        // Using Netlify Function for both ZeroBounce validation and Turnstile verification
        const zerobounceResponse = await fetch('https://mushpreneur-email-validation.netlify.app/.netlify/functions/validate-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: email,
            turnstileToken: turnstileToken
          })
        });
        
        if (!zerobounceResponse.ok) {
          throw new Error(`HTTP error! status: ${zerobounceResponse.status}`);
        }
        
        const validationData = await zerobounceResponse.json();
        console.log('Validation data:', validationData);

        // Check if turnstile verification failed
        if (validationData.turnstileError) {
          responseMessage.innerText = "Verification challenge failed. Please try again.";
          responseMessage.classList.add("text-orange");
          resetTurnstile();
          return;
        }
        console.log("✅ Turnstile server-side verification passed");

        // ZeroBounce status can be: valid, invalid, catch-all, unknown, spamtrap, abuse, do_not_mail
        if (validationData.status !== "valid") {
          responseMessage.innerText = "Invalid or undeliverable email address.";
          responseMessage.classList.add("text-orange");
          return;
        }
        console.log("✅ ZeroBounce email validation passed");

      } catch (error) {
        console.error("Validation error:", error);
        responseMessage.innerText = "Validation failed. Please try again.";
        responseMessage.classList.add("text-orange");
        return;
      }

      // 6️⃣ Proceed with API request after all validations
      console.log("✅ All validations passed, proceeding with Klaviyo subscription");
      const KLAVIYO_PUBLIC_API_KEY = "VqRB85";
      const LIST_ID = "Xd8yqJ";
      const url = `https://a.klaviyo.com/client/subscriptions?company_id=${KLAVIYO_PUBLIC_API_KEY}`;

      const payload = JSON.stringify({
        data: {
          type: "subscription",
          attributes: {
            profile: {
              data: {
                type: "profile",
                attributes: {
                  email: email,
                  subscriptions: {
                    email: {
                      marketing: {
                        consent: "SUBSCRIBED",
                        consented_at: new Date().toISOString(),
                      },
                    },
                  },
                },
              },
            },
            custom_source: "Coming Soon",
          },
          relationships: {
            list: {
              data: {
                type: "list",
                id: LIST_ID,
              },
            },
          },
        },
      });

      const options = {
        method: "POST",
        headers: {
          accept: "application/vnd.api+json",
          "content-type": "application/vnd.api+json",
          revision: "2025-01-15",
        },
        body: payload,
      };

      try {
        const response = await fetch(url, options);
        const text = await response.text();

        console.log("Raw Response:", text); // Debugging

        let result;
        if (text) {
          try {
            result = JSON.parse(text);
          } catch (jsonError) {
            console.warn("Response is not valid JSON:", text);
            result = { message: text };
          }
        } else {
          result = { message: "Success (no response body)" };
        }

        if (response.ok) {
          responseMessage.classList.add("text-successgreen");
          responseMessage.innerText =
            "Thank you for joining the Day Shrooms Launch List! Your first email is on its way to your inbox.";
          form.reset();
          resetTurnstile();
          turnstileContainer.classList.remove("visible");
          turnstileShown = false;
        } else {
          console.error("Klaviyo API Error:", result);
          responseMessage.classList.add("text-orange");
          responseMessage.innerText = `Error: ${
            result.errors?.[0]?.detail || "Something went wrong"
          }`;
        }
      } catch (error) {
        console.error("Network Error:", error);
      }
    });
  });
</script>




{%  schema  %} 
    {
        "name": "Coming Soon - Hero",
        "class": "section--coming-soon-hero",
        "settings": [
            {
                "type": "color",
                "id": "background",
                "label": "Background Color"
            },
            {
                "type": "image_picker",
                "id": "image_desk",
                "label": "Image Desktop"
            },
            {
                "type": "image_picker",
                "id": "image_mob",
                "label": "Image Mobile"
            },
            {
                "type": "textarea",
                "id": "header",
                "label": "Header",
                "default": "Mushrooms are smart. <br/> Day Shrooms are smarter."
            },
            {
                "type": "text",
                "id": "subheader",
                "label": "Subheader",
                "default": "Meet Day Shrooms—a lifestyle upgrade for those tired of the midday slump. Challenge your morning joe with a smarter, better way to fuel productivity, focus, flow, and well-being. Join the launch list now for exclusive early access and updates."
            }
        ],
        "blocks": [
            {
                "name": "USP",
                "type": "usp",
                "limit": 5,
                "settings": [
                    {
                        "type": "text",
                        "id": "usp",
                        "label": "USP"
                    }
                ]
            }
        ],
        "presets": [
            {
                "name": "Coming Soon - Hero"
            }
        ]
    } 
{% endschema %}


