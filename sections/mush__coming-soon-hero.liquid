<form id="klaviyo-signup-form--comingsoon" method="post" accept-charset="UTF-8" class="newsletter-form password--newsletter-form flex flex-col xl:flex-row items-center gap-4 justify-center w-full">
    <input type="hidden" name="form_type" value="customer">
    <input type="hidden" name="utf8" value="✓">
    
    <!-- Honeypot Field (Bots will fill this, humans won't) -->
    <input type="text" name="extra_field" id="honeypot-field" style="display:none !important;" autocomplete="off">

    <input 
        type="email" 
        name="email" 
        id="comingsoon-newsletter-email" 
        placeholder="Email" 
        class="bg-transparent w-full px-7 py-4 border border-white rounded-[62px] w-full text-sm xl:text-xl tracking-[-0.7px] xl:tracking-[-1.037px] font-light" 
        required>
    
    <!-- Google reCAPTCHA -->
    <div class="g-recaptcha" data-sitekey="YOUR_GOOGLE_RECAPTCHA_SITE_KEY"></div>

    <button type="submit" class="coming-soon--submit-btn w-full min-h-[54px] btn bg-gradient-to-r from-[#F2008C] to-[#E74936] text-white uppercase cursor-pointer text-sm xl:text-xl font-semibold leading-[1.1] tracking-[-0.7px] xl:tracking-[-1.037px]">JOIN THE LIST</button>
</form>

<p id="response-message-cs" class="text-sm xl:text-base tracking-[-0.8px] xl:tracking-[-0.8px] absolute bottom-[-24px] xl:bottom-[-30px]"></p>

<!-- Include Google reCAPTCHA script -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script>
  document.getElementById('klaviyo-signup-form--comingsoon').addEventListener('submit', async function (e) {
    e.preventDefault();

    const email = document.getElementById('comingsoon-newsletter-email').value;
    const honeypotField = document.getElementById('honeypot-field').value; // Honeypot check
    const captchaResponse = grecaptcha.getResponse(); // reCAPTCHA response

    const KLAVIYO_PUBLIC_API_KEY = 'VqRB85'; 
    const LIST_ID = 'Xd8yqJ'; 

    // 1️⃣ Basic Email Validation (Regex)
    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if (!emailPattern.test(email)) {
      document.getElementById('response-message-cs').innerText = 'Invalid email address.';
      document.getElementById('response-message-cs').classList.add('text-orange');
      return;
    }

    // 2️⃣ Honeypot Check (If filled, stop submission)
    if (honeypotField) {
      console.warn("Spam bot detected. Form submission aborted.");
      return;
    }

    // 3️⃣ reCAPTCHA Validation
    if (!captchaResponse) {
      document.getElementById('response-message-cs').innerText = 'Please complete the CAPTCHA.';
      document.getElementById('response-message-cs').classList.add('text-orange');
      return;
    }

    const url = `https://a.klaviyo.com/client/subscriptions?company_id=${KLAVIYO_PUBLIC_API_KEY}`;
    
    const payload = JSON.stringify({
      data: {
        type: 'subscription',
        attributes: {
          profile: {
            data: {
              type: 'profile',
              attributes: {
                email: email,
                subscriptions: {
                  email: {
                    marketing: {
                      consent: 'SUBSCRIBED',
                      consented_at: new Date().toISOString()
                    }
                  }
                }
              }
            }
          },
          custom_source: 'Coming Soon'
        },
        relationships: {
          list: {
            data: {
              type: 'list',
              id: LIST_ID
            }
          }
        }
      }
    });

    const options = {
      method: 'POST',
      headers: {
        accept: 'application/vnd.api+json',
        'content-type': 'application/vnd.api+json',
        revision: '2025-01-15'
      },
      body: payload
    };

    try {
      const response = await fetch(url, options);
      const text = await response.text(); // Get raw response

      console.log('Raw Response:', text); // Debugging

      let result;
      if (text) {
        try {
          result = JSON.parse(text); // Attempt JSON parsing
        } catch (jsonError) {
          console.warn('Response is not valid JSON:', text);
          result = { message: text }; // Treat it as plain text
        }
      } else {
        result = { message: 'Success (no response body)' }; // Handle empty response
      }

      if (response.ok) {
        document.getElementById('response-message-cs').classList.add('text-successgreen');
        document.getElementById('response-message-cs').innerText = 'Thank you for subscribing!';
        document.getElementById('klaviyo-signup-form--comingsoon').reset();
        grecaptcha.reset(); // Reset reCAPTCHA after submission
      } else {
        console.error('Klaviyo API Error:', result);
        document.getElementById('response-message-cs').classList.add('text-orange');
        document.getElementById('response-message-cs').innerText = `Error: ${result.errors?.[0]?.detail || 'Something went wrong'}`;
      }
    } catch (error) {
      console.error('Network Error:', error);
      document.getElementById('response-message-cs').innerText = 'An unexpected error occurred.';
    }
  });
</script>



{%  schema  %} 
  {
      "name": "Coming Soon - Hero",
      "class": "section--coming-soon-hero",
      "settings": [
          {
              "type": "color",
              "id": "background",
              "label": "Background Color"
          },
          {
              "type": "image_picker",
              "id": "image_desk",
              "label": "Image Desktop"
          },
          {
              "type": "image_picker",
              "id": "image_mob",
              "label": "Image Mobile"
          },
          {
              "type": "textarea",
              "id": "header",
              "label": "Header",
              "default": "Mushrooms are smart. <br/> Day Shrooms are smarter."
          },
          {
              "type": "text",
              "id": "subheader",
              "label": "Subheader",
              "default": "Meet Day Shrooms—a lifestyle upgrade for those tired of the midday slump. Challenge your morning joe with a smarter, better way to fuel productivity, focus, flow, and well-being. Join the launch list now for exclusive early access and updates."
          }
      ],
      "blocks": [
          {
              "name": "USP",
              "type": "usp",
              "limit": 5,
              "settings": [
                  {
                      "type": "text",
                      "id": "usp",
                      "label": "USP"
                  }
              ]
          }
      ],
      "presets": [
          {
              "name": "Coming Soon - Hero"
          }
      ]
  } 
{% endschema %}